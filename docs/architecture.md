# Architecture

Ground Control currently favors safety over performance. For instance models
are deeply copied in a lot of cases, perhaps even when not necessary.

## GraphQL

Ground Control is a GraphQL server. It uses `github.com/99designs/gqlgen` to
generate code before the app is compiled. By default, `gqlgen` generates simple
Go structs for the GraphQL types. Ground Control uses its own generators in the
`groundcontrol/plugin` to generate types, since a lot of assumptions can be
made about models. Running `go generate` triggers `script/gqlgen.go`, and
generates all the GraphQL code from the schema.

Ground Control stores all its models in memory. The package
`groundcontrol/store` contains low-level functionality to load, store, and lock
models. It is rarely used directly. The code generator generates types that are
much easier to work with. It also looks at custom directives in the GraphQL
schema to generate code to:

- add relations between models
- deal with Relay pagination
- add events to models
- automatically create mutations for jobs
- automatically create resolvers for subscriptions

Custom methods can be added to models in `groundcontrol/model`, but in a lot of
cases the generated code is enough.

Some mutations that currently cannot be automatically generated are implemented
by hand in `groundcontrol/resolver`.

## Context

The package `groundcontrol/appcontext` is used to attach an app context
to the Go context that is passed to most app functions. It is a great reference
to see the available functionality. The context must also be passed to all the
generated model functions. It makes it possible to pass variables to functions
that are generated by `gqlgen`, and to avoid having global variables. Since the
types in the app context are mostly interfaces, it also makes it easy to mock
it during tests.

## Jobs

Since a lot of tasks take a long time to run, Ground Control uses a work queue
defined in `groundcontrol/work` to schedule jobs. It runs a maximum number of
jobs at the same time.

Jobs that are periodically created, such as syncing the sources and the
projects with Git, are executed with a NORMAL priority. Jobs that are created
as a result of a user action (via a mutation) have a HIGH priority.

The actual jobs are defined in the `groundcontrol/job` package. They are called
by the periodic scheduler, or by the automatically generated mutations.

## Services and Tasks

The service manager defined in `groundcontrol/service` handles starting
services and their dependencies. It leverages the topological sort algorithm
of the `Service` model to figure out which services to launch. It uses the
package `groundcontrol/shell` to launch the process of a service.

Tasks are executed by the `Task` model, which also uses `groundcontrol/shell`
to run shell commands.

## User Interface

The user interface lives in a separate Git repository at
`https://github.com/stratumn/groundcontrol-ui`. When the `groundcontrol`
executable is built, usually using `goreleaser`, a virtual file system
containing all the files of the UI is generated by `script/uigen` using
`github.com/shurcooL/vfsgen`. A file server is added to the router to deliver
those files. That way a single binary is generated for everything.
